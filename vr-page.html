<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>VR校园全景漫游</title>
    <link href="css/global.css" rel="stylesheet"/>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <p>正在加载VR场景...</p>
        <div class="error-message" id="error-message">
            加载失败，请刷新页面重试
        </div>
    </div>

    <a-scene vr-mode-ui="enabled: true" id="vr-scene">
        <a-sky id="sky" src="assets/panorama/main.jpg"></a-sky>

        <!-- 导航点 -->
        <a-entity id="points">
            <a-image 
                id="point1" 
                src="assets/info/point1.png" 
                width="2" 
                height="2" 
                position="5 1.5 -5"
                look-at="[camera]"
                class="clickable"
                data-panorama="assets/panorama/point1.jpg"
                data-info="图书馆">
            </a-image>

            <a-image 
                id="point2" 
                src="assets/info/point2.png" 
                width="2" 
                height="2" 
                position="-5 1.5 5"
                look-at="[camera]"
                class="clickable"
                data-panorama="assets/panorama/point2.jpg"
                data-info="教学楼">
            </a-image>
        </a-entity>

        <!-- 信息面板 -->
        <a-entity id="info-panel" visible="false">
            <a-plane 
                position="0 1.5 -3" 
                width="4" 
                height="2" 
                color="#ffffff" 
                opacity="0.8">
            </a-plane>
            <a-text 
                id="info-text" 
                position="0 1.5 -2.9" 
                width="3.8" 
                height="1.8"
                align="center"
                value="">
            </a-text>
        </a-entity>

        <!-- 相机 -->
        <a-camera>
            <a-cursor></a-cursor>
        </a-camera>
    </a-scene>

    <div class="vr-controls">
        <button class="vr-button" id="reset-btn">重置视角</button>
        <button class="vr-button" id="auto-rotate-btn">自动旋转</button>
    </div>

    <div class="vr-ui">
        <div class="back-button">
            <a href="index.html">返回首页</a>
        </div>
        <div class="vr-info">
            <p>点击图像导航到不同地点</p>
            <p>或戴上VR眼镜体验沉浸式漫游</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('#vr-scene');
            const sky = document.querySelector('#sky');
            const loadingScreen = document.querySelector('#loading-screen');
            const errorMessage = document.querySelector('#error-message');
            const points = document.querySelectorAll('.clickable');
            const infoPanel = document.querySelector('#info-panel');
            const infoText = document.querySelector('#info-text');
            const resetBtn = document.querySelector('#reset-btn');
            const autoRotateBtn = document.querySelector('#auto-rotate-btn');

            let autoRotate = false;
            let rotationInterval;

            // 场景加载完成事件
            scene.addEventListener('loaded', function() {
                // 延迟隐藏加载屏幕，确保场景完全加载
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1500);
            });

            // 场景加载错误处理
            scene.addEventListener('error', function() {
                errorMessage.style.display = 'block';
                loadingScreen.querySelector('p').textContent = '加载VR场景时出错';
            });

            // 图片加载错误处理
            sky.addEventListener('materialtextureloaded', function() {
                console.log('全景图加载成功');
            });

            sky.addEventListener('materialtextureerror', function() {
                errorMessage.style.display = 'block';
                errorMessage.textContent = '无法加载全景图，请检查资源路径';
            });

            // 导航点点击事件
            points.forEach(point => {
                point.addEventListener('click', function() {
                    const panoramaSrc = this.getAttribute('data-panorama');
                    const info = this.getAttribute('data-info');

                    // 更新全景图
                    sky.setAttribute('src', panoramaSrc);

                    // 显示信息
                    infoText.setAttribute('value', info);
                    infoPanel.setAttribute('visible', 'true');

                    // 3秒后隐藏信息面板
                    setTimeout(() => {
                        infoPanel.setAttribute('visible', 'false');
                    }, 3000);
                });
            });

            // 重置视角按钮
            resetBtn.addEventListener('click', function() {
                const camera = document.querySelector('a-camera');
                camera.setAttribute('rotation', '0 0 0');
                camera.setAttribute('position', '0 0 0');
            });

            // 自动旋转按钮
            autoRotateBtn.addEventListener('click', function() {
                autoRotate = !autoRotate;

                if (autoRotate) {
                    this.textContent = '停止旋转';
                    this.style.backgroundColor = 'rgba(255, 87, 34, 0.8)';

                    rotationInterval = setInterval(() => {
                        const camera = document.querySelector('a-camera');
                        const rotation = camera.getAttribute('rotation');
                        camera.setAttribute('rotation', {
                            x: rotation.x,
                            y: rotation.y + 1,
                            z: rotation.z
                        });
                    }, 50);
                } else {
                    this.textContent = '自动旋转';
                    this.style.backgroundColor = 'rgba(74, 109, 229, 0.8)';
                    clearInterval(rotationInterval);
                }
            });
        });
    </script>
</body>
</html>